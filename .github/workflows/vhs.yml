name: Generate GIF (VHS)

on:
  # É melhor rodar quando há mudanças na main (código ou tape)
  push:
    branches:
      - main
    paths:
      - '**.rs'        # Só roda se mudar código Rust
      - 'try-rs.tape'  # Ou se mudar o script do VHS
  
  # Gatilho manual continua útil
  workflow_dispatch:

jobs:
  vhs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Importante: busca o histórico completo para evitar problemas de merge/push
          fetch-depth: 0 
      
      # chromium-browser
      - name: Install System Dependencies 
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libnss3 libxss1 libasound2t64 fish ttyd

      - name: Install try-rs from APT
        run: |
          # Adiciona o repositório
          echo "deb [trusted=yes] https://tassiovirginio.github.io/try-rs stable main" | sudo tee /etc/apt/sources.list.d/try-rs.list
          
          # Atualiza e instala
          sudo apt update
          sudo apt install -y try-rs
          
          # Verifica instalação
          which try-rs
          try-rs --version

      - name: Install Nerd Fonts
        run: |
          # Instala no diretório do sistema para garantir que o VHS encontre
          sudo mkdir -p /usr/local/share/fonts/nerd-fonts
          cd /usr/local/share/fonts/nerd-fonts
          
          # Baixa e instala JetBrainsMono Nerd Font
          sudo curl -fLO https://github.com/ryanoasis/nerd-fonts/releases/download/v3.3.0/JetBrainsMono.zip
          sudo unzip -o JetBrainsMono.zip
          sudo rm JetBrainsMono.zip
          
          # Também instala no diretório do usuário
          mkdir -p ~/.local/share/fonts
          cp *.ttf ~/.local/share/fonts/ 2>/dev/null || true
          
          # Atualiza cache de fontes
          sudo fc-cache -fv
          fc-cache -fv
          
          echo "✅ Nerd Fonts instaladas:"
          fc-list | grep -i "JetBrains"
          
          # Mostra o nome exato da fonte para debug
          echo "Nome exato das fontes:"
          fc-list : family | grep -i jet | sort -u

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Install VHS
        run: go install github.com/charmbracelet/vhs@latest

      - name: Run VHS
        # Define explicitamente que este passo deve ser interpretado pelo Fish
        shell: fish {0}
        run: |
          # Salva o diretório de trabalho original
          set -l WORK_DIR $PWD
          echo "Diretório de trabalho original: $WORK_DIR"
          
          # Debug para confirmar
          echo "Rodando dentro do Fish!"
          which try-rs
          try-rs --version
          
          # Setup shell integration para o comando 'try' funcionar
          try-rs --setup fish
          source ~/.config/fish/functions/try-rs.fish
          try-rs -s https://github.com/tassiovirginio/dnose.git
          try-rs -s https://github.com/Prajwal-Prathiksh/battery-zen.git
          try-rs -s https://github.com/arieslab/jnose.git
          try-rs -s https://github.com/rust-lang/book.git
          try-rs -s https://github.com/tassiovirginio/try-rs.git
          try-rs -s https://github.com/Zeus-Deus/gazelle-tui.git
          try-rs -s https://github.com/tassiovirginio/envy-tui.git
          try-rs -s https://github.com/rust-lang/rustlings.git
          try-rs -s https://github.com/tassiovirginio/firststepinagile.git
          try-rs -s https://github.com/arieslab/jnose-core.git
          
          # IMPORTANTE: Volta para o diretório original
          cd $WORK_DIR
          echo "Voltando para: $PWD"
          
          # Debug: mostra GIF antes do VHS
          echo "GIF antes do VHS:"
          ls -lh try-rs.gif 2>/dev/null || echo "GIF não existe ainda"
          
          # Executa o VHS com caminho absoluto para o output
          echo "Iniciando VHS..."
          vhs $WORK_DIR/try-rs.tape -o $WORK_DIR/try-rs.gif
          
          # Debug: mostra GIF depois do VHS
          echo "GIF depois do VHS:"
          ls -lh $WORK_DIR/try-rs.gif
          
          # Verifica se o GIF foi criado
          if test -f $WORK_DIR/try-rs.gif
            echo "✅ VHS executou com sucesso - GIF criado"
          else
            echo "❌ VHS falhou - GIF não foi criado"
            exit 1
          end

      - name: Verify GIF was generated
        run: |
          echo "Diretório atual: $(pwd)"
          echo "Listando arquivos GIF:"
          ls -la *.gif || echo "Nenhum arquivo .gif encontrado"
          
          if [ ! -f try-rs.gif ]; then
            echo "❌ ERRO: try-rs.gif não foi gerado!"
            exit 1
          fi
          
          echo "✅ GIF gerado com sucesso:"
          ls -lh try-rs.gif
          
          # Mostra hash do arquivo para debug
          md5sum try-rs.gif || sha256sum try-rs.gif

      - name: Download current APT repo
        run: |
          mkdir -p pages-content
          
          # Baixa o conteúdo atual do GitHub Pages (APT repo)
          wget -r -np -nH --cut-dirs=1 -P pages-content \
            https://tassiovirginio.github.io/try-rs/ 2>/dev/null || true
          
          # Limpa arquivos desnecessários do wget
          find pages-content -name "*.html" -delete 2>/dev/null || true
          find pages-content -name "index.html*" -delete 2>/dev/null || true
          
          echo "Conteúdo atual do Pages:"
          ls -la pages-content/ || echo "Diretório vazio"

      - name: Prepare Pages content with GIF
        run: |
          # Copia o GIF para o diretório do Pages
          cp try-rs.gif pages-content/
          
          echo "✅ Conteúdo preparado para deploy:"
          ls -la pages-content/

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages-content

  deploy:
    runs-on: ubuntu-latest
    needs: vhs
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
