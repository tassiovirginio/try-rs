name: Generate GIF (VHS)

on:
  # É melhor rodar quando há mudanças na main (código ou tape)
  push:
    branches:
      - main
    paths:
      - '**.rs'        # Só roda se mudar código Rust
      - 'try-rs.tape'  # Ou se mudar o script do VHS
  
  # Gatilho manual continua útil
  workflow_dispatch:

jobs:
  vhs:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Permissão CRÍTICA para poder fazer push

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Importante: busca o histórico completo para evitar problemas de merge/push
          fetch-depth: 0 
      
      # chromium-browser
      - name: Install System Dependencies 
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libnss3 libxss1 libasound2t64 fish ttyd

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Install VHS
        run: go install github.com/charmbracelet/vhs@latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build try-rs
        run: cargo build --release

      - name: Run VHS
        # Define explicitamente que este passo deve ser interpretado pelo Fish
        shell: fish {0}
        run: |
          # Debug: mostra diretório atual
          echo "Diretório de trabalho: $PWD"
          
          # Sintaxe do Fish para adicionar ao PATH e exportar (-x)
          set -x PATH "$PWD/target/release" $PATH
          
          # Debug para confirmar
          echo "Rodando dentro do Fish!"
          which try-rs
          try-rs --version
          
          # Setup shell integration para o comando 'try' funcionar
          try-rs --setup fish
          source ~/.config/fish/functions/try-rs.fish
          try-rs example1
          try-rs example2
          try-rs example3
          try-rs example4
          try-rs https://github.com/tassiovirginio/try-rs.git
          
          # Debug: mostra GIF antes do VHS
          echo "GIF antes do VHS:"
          ls -lh try-rs.gif 2>/dev/null || echo "GIF não existe ainda"
          
          # Executa o VHS
          echo "Iniciando VHS..."
          vhs try-rs.tape
          
          # Debug: mostra GIF depois do VHS
          echo "GIF depois do VHS:"
          ls -lh try-rs.gif
          
          # Verifica se o GIF foi criado
          if test -f try-rs.gif
            echo "✅ VHS executou com sucesso - GIF criado"
          else
            echo "❌ VHS falhou - GIF não foi criado"
            exit 1
          end

      - name: Verify GIF was generated
        run: |
          echo "Diretório atual: $(pwd)"
          echo "Listando arquivos GIF:"
          ls -la *.gif || echo "Nenhum arquivo .gif encontrado"
          
          if [ ! -f try-rs.gif ]; then
            echo "❌ ERRO: try-rs.gif não foi gerado!"
            exit 1
          fi
          
          echo "✅ GIF gerado com sucesso:"
          ls -lh try-rs.gif
          
          # Mostra hash do arquivo para debug
          md5sum try-rs.gif || sha256sum try-rs.gif
          
          # Mostra status do git
          git status try-rs.gif

      - name: Commit and Push GIF
        run: |
          git config user.name "Tássio Virginio"
          git config user.email "tassiovirginio@gmail.com"
          
          # Força adicionar o arquivo (ignora .gitignore se houver)
          git add -f try-rs.gif
          
          # Debug: mostra o status
          git status
          
          # Verifica se há mudanças para commitar
          if git diff --cached --quiet; then
            echo "ℹ️ Nenhuma mudança no GIF - nada para commitar"
            echo "Debug: comparando arquivos..."
            git diff --cached --stat || true
            exit 0
          fi
          
          git commit -m "docs: update demo gif [skip ci]"
          git push
          echo "✅ GIF atualizado no repositório com sucesso!"
          
