name: Generate GIF (VHS)

on:
  # Run when try-rs.tape is modified
  push:
    branches:
      - main
    paths:
      - "try-rs.tape"
  
  # Manual trigger
  workflow_dispatch:

jobs:
  vhs:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for push

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Important: fetch full history to avoid merge/push issues
          fetch-depth: 0
          ref: main
      
      - name: Install System Dependencies 
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libnss3 libxss1 libasound2t64 fish ttyd

      - name: Install try-rs from APT
        run: |
          # Add the repository
          echo "deb [trusted=yes] https://tassiovirginio.github.io/try-rs stable main" | sudo tee /etc/apt/sources.list.d/try-rs.list
          
          # Update and install
          sudo apt update
          sudo apt install -y try-rs
          
          # Verify installation
          which try-rs
          try-rs --version

      - name: Install Nerd Fonts
        run: |
          # Install in system directory to ensure VHS can find it
          sudo mkdir -p /usr/local/share/fonts/nerd-fonts
          cd /usr/local/share/fonts/nerd-fonts
          
          # Download and install JetBrainsMono Nerd Font
          sudo curl -fLO https://github.com/ryanoasis/nerd-fonts/releases/download/v3.3.0/JetBrainsMono.zip
          sudo unzip -o JetBrainsMono.zip
          sudo rm JetBrainsMono.zip
          
          # Also install in user directory
          mkdir -p ~/.local/share/fonts
          cp *.ttf ~/.local/share/fonts/ 2>/dev/null || true
          
          # Update font cache
          sudo fc-cache -fv
          fc-cache -fv
          
          echo "✅ Nerd Fonts installed:"
          fc-list | grep -i "JetBrains"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Install VHS
        run: go install github.com/charmbracelet/vhs@latest

      - name: Run VHS
        shell: fish {0}
        run: |
          # Create try-rs config to disable transparent background
          mkdir -p ~/.config/try-rs
          echo 'transparent_background = false' >> ~/.config/try-rs/config.toml

          # Save the original working directory
          set -l WORK_DIR $PWD
          echo "Original working directory: $WORK_DIR"
          
          echo "Running inside Fish!"
          which try-rs
          try-rs --version
          
          # Setup shell integration
          try-rs --setup fish
          source ~/.config/fish/functions/try-rs.fish
          try-rs -s https://github.com/tassiovirginio/dnose.git
          try-rs -s https://github.com/Prajwal-Prathiksh/battery-zen.git
          try-rs -s https://github.com/arieslab/jnose.git
          try-rs -s https://github.com/rust-lang/book.git
          try-rs -s https://github.com/tassiovirginio/try-rs.git
          try-rs -s https://github.com/Zeus-Deus/gazelle-tui.git
          try-rs -s https://github.com/tassiovirginio/envy-tui.git
          try-rs -s https://github.com/rust-lang/rustlings.git
          try-rs -s https://github.com/tassiovirginio/firststepinagile.git
          try-rs -s https://github.com/arieslab/jnose-core.git
          
          # Return to original directory
          cd $WORK_DIR
          echo "Returning to: $PWD"
          
          # Run VHS with absolute path for output
          echo "Starting VHS..."
          vhs $WORK_DIR/try-rs.tape -o $WORK_DIR/try-rs.gif
          
          # Check if GIF was created
          if test -f $WORK_DIR/try-rs.gif
            echo "✅ VHS executed successfully - GIF created"
            ls -lh $WORK_DIR/try-rs.gif
          else
            echo "❌ VHS failed - GIF not created"
            exit 1
          end

      - name: Commit and Push GIF
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add try-rs.gif
          
          # Check if GIF changed before commit
          if git diff --staged --quiet; then
            echo "⚠️ Generated GIF is identical to current. Nothing to commit."
          else
            git commit -m "docs: update demo gif [skip ci]"
            git push
            echo "✅ GIF updated in repository successfully!"
          fi
