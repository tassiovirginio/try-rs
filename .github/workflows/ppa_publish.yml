name: Publish to PPA

on:
  push:
    tags:
      - 'v*' # Dispara quando você cria uma tag como v0.1.35
  workflow_dispatch: # Adiciona o botão para disparo manual
    inputs:
      tag_name:
        description: 'Tag para buildar (ex: v0.1.35)'
        required: true
        default: 'v0.1.35'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Debian Packaging Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y debhelper devscripts dput-ng python3-debian build-essential cargo rustc libstd-rust-dev fakeroot

      - name: Import GPG Key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Prepare Debian Source Package
        run: |
          # Pega a versão EXATA do changelog (ex: 0.1.35)
          VERSION=$(dpkg-parsechangelog -S Version | cut -d'-' -f1)
          echo "Versão detectada no changelog: $VERSION"
          
          # Cria o tarball com o nome que o Launchpad exige (nome_versão.orig.tar.gz)
          tar -czf ../try-rs_${VERSION}.orig.tar.gz .
          
          # Constrói o pacote de origem
          dpkg-buildpackage -S -us -uc

      - name: Sign and Upload to PPA
        run: |
          VERSION=$(dpkg-parsechangelog -S Version | cut -d'-' -f1)
          PACKAGE=$(dpkg-parsechangelog -S Source)
          debsign -k 189688CC065493DF24F54A05929893C048105286 ../${PACKAGE}_${VERSION}-1_source.changes
          dput ppa:tassiovirginio/try-rs ../${PACKAGE}_${VERSION}-1_source.changes
          
